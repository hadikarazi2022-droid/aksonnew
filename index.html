<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Akson Web Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root {
      color-scheme: dark;
      --bg: #0b1220;
      --panel: #0f172a;
      --muted: #94a3b8;
      --accent: #2563eb;
      --border: #1f2937;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:#e2e8f0;min-height:100vh;display:flex;flex-direction:column}
    header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:rgba(15,23,42,0.8);backdrop-filter:blur(10px);position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:20px;font-weight:700}
    header .status{color:var(--muted);font-size:14px}
    main{flex:1;display:grid;grid-template-columns:1fr 320px;gap:0;border-top:1px solid var(--border);min-height:0}
    .viewer{background:#000;display:flex;min-height:0}
    .viewer iframe{border:0;flex:1;min-height:0}
    .sidebar{background:var(--panel);border-left:1px solid var(--border);display:flex;flex-direction:column;min-height:0}
    .sidebar header{position:static;border:0;padding:14px 16px}
    .list{padding:8px;overflow:auto;flex:1;display:flex;flex-direction:column;gap:8px}
    .item{padding:12px;border:1px solid var(--border);border-radius:10px;background:#0c1324;cursor:pointer;transition:background .15s,border-color .15s}
    .item:hover{border-color:#334155;background:#121b32}
    .item.active{border-color:var(--accent);background:#13203d}
    .item-title{margin:0 0 4px;font-weight:600;font-size:15px}
    .item-meta{margin:0;color:var(--muted);font-size:12px}
    .empty{padding:16px;color:var(--muted);text-align:center}
    .error{color:#f87171;padding:12px;text-align:center}
  </style>
</head>
<body>
  <header>
    <h1>Akson Web Viewer</h1>
    <div class="status" id="status">Loading library…</div>
  </header>
  <main>
    <section class="viewer">
      <iframe id="pdf-frame" title="PDF Viewer" src="/pdfjs/web/viewer.html?file=/pdfjs/web/compressed.tracemonkey-pldi-09.pdf"></iframe>
    </section>
    <aside class="sidebar">
      <header>
        <div class="status" id="count">0 notes · 0 cards</div>
      </header>
      <div class="list" id="list"></div>
    </aside>
  </main>

  <template id="item-template">
    <div class="item">
      <p class="item-title" data-title></p>
      <p class="item-meta" data-meta></p>
      <p class="item-meta" data-tags></p>
    </div>
  </template>

  <script>
    const statusEl = document.getElementById('status');
    const countEl = document.getElementById('count');
    const listEl = document.getElementById('list');
    const template = document.getElementById('item-template');
    const pdfFrame = document.getElementById('pdf-frame');

    function setViewer(fileUrl) {
      const url = `/pdfjs/web/viewer.html?file=${encodeURIComponent(fileUrl)}`;
      pdfFrame.src = url;
    }

    function renderItems(items) {
      listEl.innerHTML = '';
      if (!items.length) {
        listEl.innerHTML = '<div class="empty">No notes yet. Export metadata to see your library.</div>';
        return;
      }
      items.forEach((note, idx) => {
        const node = template.content.cloneNode(true);
        const el = node.querySelector('.item');
        node.querySelector('[data-title]').textContent = note.deckName || note.noteId || 'Untitled';
        node.querySelector('[data-meta]').textContent = `${note.cardCount || 0} flashcards`;
        node.querySelector('[data-tags]').textContent = note.tags?.length ? note.tags.join(', ') : 'No tags';
        el.addEventListener('click', () => {
          document.querySelectorAll('.item').forEach(i => i.classList.remove('active'));
          el.classList.add('active');
          // Use any available PDF hint; fall back to bundled sample.
          const pdfUrl = note.pdfUrl || note.path || note.sourcePath || '/pdfjs/web/compressed.tracemonkey-pldi-09.pdf';
          setViewer(pdfUrl);
        });
        if (idx === 0) el.classList.add('active');
        listEl.appendChild(node);
      });
    }

    async function loadLibrary() {
      try {
        const res = await fetch('/library');
        if (!res.ok) throw new Error('Request failed');
        const { items = [], summary = {} } = await res.json();
        statusEl.textContent = 'Ready';
        countEl.textContent = `${summary.noteCount || items.length} notes · ${summary.cardCount || 0} cards`;
        renderItems(items);
        if (items.length) {
          const first = items[0];
          const pdfUrl = first.pdfUrl || first.path || first.sourcePath || '/pdfjs/web/compressed.tracemonkey-pldi-09.pdf';
          setViewer(pdfUrl);
        }
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Failed to load library';
        listEl.innerHTML = '<div class="error">Could not load library.</div>';
      }
    }

    loadLibrary();
  </script>
</body>
</html>
